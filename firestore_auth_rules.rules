rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ðŸ›¡ï¸ å…¥åŠ›å€¤æ¤œè¨¼é–¢æ•°ï¼ˆç½å®³æ™‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
    function isValidString(str, maxLength) {
      return str is string && 
             str.size() > 0 && 
             str.size() <= maxLength &&
             !str.matches('.*[<>"%;()&+].*');
    }
    
    function isValidEmail(email) {
      return email is string && 
             email.matches('.*@.*\\..*') &&
             email.size() <= 100;
    }
    
    function isValidPhoneNumber(phone) {
      return phone is string && 
             phone.matches('^[+]?[0-9\\-\\s]{10,15}$');
    }
    
    function isValidCoordinates(lat, lng) {
      return lat is number && lng is number &&
             lat >= 35.0 && lat <= 36.0 &&
             lng >= 139.0 && lng <= 140.5;
    }
    
    function isAuthenticatedDeliveryPerson() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/delivery_persons/$(request.auth.uid));
    }
    
    // ðŸ“¦ é…é”ä¾é ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç½å®³æ™‚ç·Šæ€¥å¯¾å¿œï¼‰
    match /requests/{requestId} {
      // ðŸ” èª­ã¿å–ã‚Šï¼šèªè¨¼æ¸ˆã¿é…é”å“¡ã®ã¿
      allow read: if request.auth != null;
      
      // âœï¸ ä½œæˆï¼šè¢«ç½è€…å´ã‚¢ãƒ—ãƒªã‹ã‚‰ã®ã¿ï¼ˆåˆ¥é€”è¨­å®šï¼‰
      allow create: if request.auth != null;
      
      // ðŸ“ æ›´æ–°ï¼šæ‹…å½“é…é”å“¡ã®ã¿ï¼ˆç½å®³æ™‚è²¬ä»»è¿½è·¡ï¼‰
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.deliveryPersonId;
      
      // ðŸ—‘ï¸ å‰Šé™¤ï¼šç¦æ­¢ï¼ˆç½å®³æ™‚ãƒ‡ãƒ¼ã‚¿ä¿å…¨ï¼‰
      allow delete: if false;
    }
    
    // ðŸšš é…é”å“¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ–°è¦è¿½åŠ ï¼‰
    match /delivery_persons/{deliveryPersonId} {
      // ðŸ” èª­ã¿å–ã‚Šï¼šåŸºæœ¬æƒ…å ±ã®ã¿å…¬é–‹ï¼ˆç½å®³æ™‚èº«å…ƒç¢ºèªï¼‰
      allow read: if request.auth != null;
      
      // âœï¸ ä½œæˆï¼šæœ¬äººã®ã¿
      allow create: if request.auth != null && 
                       request.auth.uid == deliveryPersonId &&
                       isValidString(request.resource.data.name, 50) &&
                       isValidPhoneNumber(request.resource.data.phone);
      
      // ðŸ“ æ›´æ–°ï¼šæœ¬äººã®ã¿
      allow update: if request.auth != null && 
                       request.auth.uid == deliveryPersonId;
      
      // ðŸ—‘ï¸ å‰Šé™¤ï¼šç¦æ­¢ï¼ˆç½å®³æ™‚èº«å…ƒä¿æŒï¼‰
      allow delete: if false;
    }
    
    // ðŸ“Š é…é”è¨˜éŒ²ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    match /deliveries/{deliveryId} {
      // ðŸ” èª­ã¿å–ã‚Šï¼šé–¢ä¿‚è€…ã®ã¿
      allow read: if request.auth != null && 
                     (request.auth.uid == resource.data.deliveryPersonId ||
                      request.auth.uid == resource.data.requesterId);
      
      // âœï¸ ä½œæˆï¼šé…é”å“¡ã®ã¿
      allow create: if request.auth != null && 
                       isAuthenticatedDeliveryPerson();
      
      // ðŸ“ æ›´æ–°ï¼šç¦æ­¢ï¼ˆè¨˜éŒ²æ”¹ã–ã‚“é˜²æ­¢ï¼‰
      allow update: if false;
      
      // ðŸ—‘ï¸ å‰Šé™¤ï¼šç¦æ­¢ï¼ˆç½å®³æ™‚è¨˜éŒ²ä¿å…¨ï¼‰
      allow delete: if false;
    }
    
    // ðŸ  é¿é›£æ‰€æƒ…å ±ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    match /shelters/{shelterId} {
      // ðŸ” èª­ã¿å–ã‚Šï¼šå…¨å“¡å¯èƒ½ï¼ˆç½å®³æ™‚å…¬å…±æƒ…å ±ï¼‰
      allow read: if true;
      
      // âœï¸ ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ï¼šç®¡ç†è€…ã®ã¿ï¼ˆåˆ¥é€”è¨­å®šï¼‰
      allow write: if false;
    }
    
    // ðŸ” èªè¨¼ãƒ­ã‚°ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç½å®³æ™‚ç›£æŸ»ç”¨ï¼‰
    match /auth_logs/{logId} {
      // ðŸ” èª­ã¿å–ã‚Šï¼šç®¡ç†è€…ã®ã¿
      allow read: if false;
      
      // âœï¸ ä½œæˆï¼šã‚·ã‚¹ãƒ†ãƒ ã®ã¿
      allow create: if request.auth != null;
      
      // æ›´æ–°ãƒ»å‰Šé™¤ï¼šç¦æ­¢
      allow update, delete: if false;
    }
  }
}