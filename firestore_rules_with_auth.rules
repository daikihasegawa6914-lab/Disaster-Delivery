// 🔒 Firestore セキュリティルール（認証機能追加版）
// Firebase Console の Rules タブにコピー&ペーストしてください

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 📋 requests コレクション（配達要請）- 既存ルール維持
    match /requests/{requestId} {
      // 誰でも読み取り可能（被災者・配達員が要請を確認するため）
      allow read: if true;
      
      // 新規作成は誰でも可能（被災者が緊急要請を送るため）
      allow create: if true;
      
      // 更新は制限付きで許可（配達員が状況更新するため）
      allow update: if 
        // 既存のデータの重要フィールドは変更不可
        !('requesterName' in resource.data) ||
        !('item' in resource.data) ||
        !('phone' in resource.data) ||
        !('latitude' in resource.data) ||
        !('longitude' in resource.data) ||
        !('timestamp' in resource.data) ||
        // 重要フィールドが変更されていない場合のみ許可
        (resource.data.requesterName == request.data.requesterName &&
         resource.data.item == request.data.item &&
         resource.data.phone == request.data.phone &&
         resource.data.latitude == request.data.latitude &&
         resource.data.longitude == request.data.longitude &&
         resource.data.timestamp == request.data.timestamp);
      
      // 削除は完全に禁止（データ保持のため）
      allow delete: if false;
    }
    
    // 📊 deliveries コレクション（配達履歴）- 既存ルール維持
    match /deliveries/{deliveryId} {
      // 読み取りは誰でも可能（統計情報のため）
      allow read: if true;
      
      // 作成のみ許可（履歴は追加のみ）
      allow create: if true;
      
      // 更新・削除は禁止（履歴改ざん防止）
      allow update, delete: if false;
    }
    
    // 🚚 delivery_persons コレクション（配達員プロフィール）- 新規追加
    match /delivery_persons/{deliveryPersonId} {
      // 誰でも読み取り可能（災害時身元確認のため）
      allow read: if true;
      
      // 作成：認証済みユーザーの自分のプロフィールのみ
      allow create: if request.auth != null && 
                       request.auth.uid == deliveryPersonId;
      
      // 更新：認証済みユーザーの自分のプロフィールのみ
      allow update: if request.auth != null && 
                       request.auth.uid == deliveryPersonId;
      
      // 削除は禁止（災害時身元保持）
      allow delete: if false;
    }
    
    // 🏠 shelters コレクション（避難所情報）- 既存機能
    match /shelters/{shelterId} {
      // 誰でも読み取り可能（災害時公共情報）
      allow read: if true;
      
      // 書き込みは現状禁止（管理者機能は後で追加）
      allow write: if false;
    }
    
    // 🔒 その他のコレクション（将来追加用）- 既存ルール維持
    match /{document=**} {
      // デフォルトは読み取りのみ
      allow read: if true;
      allow write: if false;
    }
  }
}

/*
🛡️ 認証機能追加後のセキュリティ解説：
✅ 既存機能（変更なし）：
- 誰でも要請の読み取り・作成（緊急時対応）
- 配達状況の更新（重要データ保護）
- 配達履歴の作成・読み取り

✅ 新規追加機能：
- 配達員プロフィール管理（認証必須）
- プロフィール画像アップロード（Storage連携）

🚨 災害時の特別考慮（維持）：
- 被災者側の緊急アクセスは認証不要
- 配達員側は身元確認のため認証必須
- データ改ざん・削除防止は継続
*/