// ğŸ“ Study Mode: å°å­¦ç”Ÿã§ã‚‚åˆ†ã‹ã‚‹ï¼Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«
// ğŸ”’ ç½å®³é…é€ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«ä¿è­·

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ“š å°å­¦ç”Ÿå‘ã‘è§£èª¬: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã¨ã¯ï¼Ÿ
    // ä¾‹ï¼šå›³æ›¸é¤¨ã®ãƒ«ãƒ¼ãƒ«
    // - æœ¬ã‚’èª­ã‚€ã®ã¯èª°ã§ã‚‚OKï¼ˆread: trueï¼‰
    // - æœ¬ã‚’æ›¸ãè¾¼ã‚€ã®ã¯å¸æ›¸ã•ã‚“ã ã‘ï¼ˆwrite: èªè¨¼å¿…è¦ï¼‰
    // - ç·Šæ€¥æ™‚ã¯ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«ï¼ˆç½å®³æ™‚ã®ä¾‹å¤–å‡¦ç†ï¼‰

    // ğŸš€ é…é”ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ«ãƒ¼ãƒ«
    match /delivery_requests/{requestId} {
      // ğŸ“– èª­ã¿å–ã‚Š: èª°ã§ã‚‚å¯èƒ½ï¼ˆé…é”å“¡ãŒç¢ºèªã™ã‚‹ãŸã‚ï¼‰
      allow read: if true;
      
      // âœï¸ æ›¸ãè¾¼ã¿: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ç·Šæ€¥æ™‚
      allow write: if request.auth != null || isEmergencyMode();
      
      // ğŸ”„ æ›´æ–°: é…é”å“¡ãŒçŠ¶æ³ã‚’æ›´æ–°ã™ã‚‹ãŸã‚
      allow update: if request.auth != null 
        && (request.auth.uid == resource.data.assignedDeliveryPersonId 
            || isAdmin(request.auth.uid));
    }

    // ğŸ¥ é¿é›£æ‰€æƒ…å ±ã®ãƒ«ãƒ¼ãƒ«
    match /shelters/{shelterId} {
      // ğŸ“– èª­ã¿å–ã‚Š: èª°ã§ã‚‚å¯èƒ½ï¼ˆå…¬å…±æƒ…å ±ï¼‰
      allow read: if true;
      
      // âœï¸ æ›¸ãè¾¼ã¿: ç®¡ç†è€…ã®ã¿ï¼ˆé¿é›£æ‰€æƒ…å ±ã¯é‡è¦ï¼‰
      allow write: if isAdmin(request.auth.uid);
      
      // ğŸ”„ åå®¹äººæ•°æ›´æ–°: é¿é›£æ‰€ã‚¹ã‚¿ãƒƒãƒ•ã‚‚å¯èƒ½
      allow update: if request.auth != null 
        && (isAdmin(request.auth.uid) 
            || isShelterStaff(request.auth.uid, shelterId)
            || onlyUpdatingOccupancy());
    }

    // ğŸ“Š çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ãƒ«ãƒ¼ãƒ«
    match /daily_stats/{date} {
      // ğŸ“– èª­ã¿å–ã‚Š: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼
      allow read: if request.auth != null;
      
      // âœï¸ æ›¸ãè¾¼ã¿: ã‚·ã‚¹ãƒ†ãƒ ã®ã¿ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰
      allow write: if isSystemAccount(request.auth.uid);
    }

    // ğŸ‘¥ é…é”å“¡æƒ…å ±ã®ãƒ«ãƒ¼ãƒ«
    match /delivery_persons/{personId} {
      // ğŸ“– èª­ã¿å–ã‚Š: æœ¬äººã¾ãŸã¯ç®¡ç†è€…
      allow read: if request.auth != null 
        && (request.auth.uid == personId || isAdmin(request.auth.uid));
      
      // âœï¸ æ›¸ãè¾¼ã¿: æœ¬äººã¾ãŸã¯ç®¡ç†è€…
      allow write: if request.auth != null 
        && (request.auth.uid == personId || isAdmin(request.auth.uid));
    }

    // ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®ãƒ«ãƒ¼ãƒ«
    match /system_config/{configId} {
      // ğŸ“– èª­ã¿å–ã‚Š: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼
      allow read: if request.auth != null;
      
      // âœï¸ æ›¸ãè¾¼ã¿: ç®¡ç†è€…ã®ã¿
      allow write: if isAdmin(request.auth.uid);
    }

    // ğŸ“± ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ«ãƒ¼ãƒ«ï¼ˆé–‹ç™ºç”¨ï¼‰
    match /test_data/{document=**} {
      // ğŸ§ª ãƒ†ã‚¹ãƒˆç’°å¢ƒ: å…¨ã¦ã®æ“ä½œã‚’è¨±å¯
      allow read, write: if isTestEnvironment();
    }

    // ğŸš¨ ç·Šæ€¥æ™‚ã®ãƒ«ãƒ¼ãƒ«ï¼ˆç½å®³ç™ºç”Ÿæ™‚ï¼‰
    match /emergency/{document=**} {
      // ğŸ“– èª­ã¿å–ã‚Š: èª°ã§ã‚‚å¯èƒ½ï¼ˆç½å®³æƒ…å ±ã®å…±æœ‰ï¼‰
      allow read: if true;
      
      // âœï¸ æ›¸ãè¾¼ã¿: ç·Šæ€¥ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ç·©å’Œ
      allow write: if isEmergencyMode() || request.auth != null;
    }

    // ğŸ”’ Helper Functionsï¼ˆå°å­¦ç”Ÿå‘ã‘ï¼šä¾¿åˆ©ãªé–¢æ•°é›†ï¼‰
    
    // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯ï¼ˆæ ¡é•·å…ˆç”Ÿã‹ã©ã†ã‹ï¼Ÿï¼‰
    function isAdmin(userId) {
      return userId in [
        'admin_user_1',  // ãƒ¡ã‚¤ãƒ³ç®¡ç†è€…
        'admin_user_2',  // å‰¯ç®¡ç†è€…
        'system_account' // ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
      ];
    }

    // ç·Šæ€¥ãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆç½å®³ç™ºç”Ÿä¸­ï¼Ÿï¼‰
    function isEmergencyMode() {
      // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‹ã‚‰å–å¾—
      // ç¾åœ¨ã¯é–‹ç™ºç”¨ã«å¸¸ã«false
      return false;
    }

    // ãƒ†ã‚¹ãƒˆç’°å¢ƒãƒã‚§ãƒƒã‚¯ï¼ˆç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼Ÿï¼‰
    function isTestEnvironment() {
      // é–‹ç™ºç’°å¢ƒã‚„ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®å‹•ä½œç¢ºèªç”¨
      return request.auth != null && request.auth.uid.contains('test_');
    }

    // ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªå‹•å‡¦ç†ï¼Ÿï¼‰
    function isSystemAccount(userId) {
      return userId == 'system_account' || userId.contains('firebase_');
    }

    // é¿é›£æ‰€ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚§ãƒƒã‚¯ï¼ˆãã®é¿é›£æ‰€ã®è·å“¡ï¼Ÿï¼‰
    function isShelterStaff(userId, shelterId) {
      // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€staff_assignmentsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç¢ºèª
      return exists(/databases/$(database)/documents/staff_assignments/$(userId + '_' + shelterId));
    }

    // åå®¹äººæ•°ã®ã¿æ›´æ–°ãƒã‚§ãƒƒã‚¯ï¼ˆä»–ã®æƒ…å ±ã¯å¤‰æ›´ã—ã¦ã„ãªã„ï¼Ÿï¼‰
    function onlyUpdatingOccupancy() {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['currentOccupancy', 'lastUpdated']);
    }
  }
}

/* ğŸ“š å°å­¦ç”Ÿå‘ã‘å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆï¼š

1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®3åŸå‰‡**:
   - ğŸ“– èª­ã¿å–ã‚Šæ¨©é™: å¿…è¦ãªäººãŒæƒ…å ±ã‚’è¦‹ã‚‰ã‚Œã‚‹
   - âœï¸ æ›¸ãè¾¼ã¿æ¨©é™: è²¬ä»»ã®ã‚ã‚‹äººã ã‘ãŒå¤‰æ›´ã§ãã‚‹
   - ğŸ”„ æ›´æ–°æ¨©é™: éƒ¨åˆ†çš„ãªå¤‰æ›´ã¯æŸ”è»Ÿã«å¯¾å¿œ

2. **ç½å®³æ™‚ã®ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«**:
   - ç·Šæ€¥æ™‚ã¯é€šå¸¸ã‚ˆã‚Šç·©ã„ãƒ«ãƒ¼ãƒ«
   - å…¬å…±ã®å®‰å…¨ãŒæœ€å„ªå…ˆ
   - ã§ã‚‚ã€åŸºæœ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯ç¶­æŒ

3. **æ®µéšçš„ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**:
   - ä¸€èˆ¬åˆ©ç”¨è€… < é…é”å“¡ < é¿é›£æ‰€ã‚¹ã‚¿ãƒƒãƒ• < ç®¡ç†è€…
   - ãã‚Œãã‚Œã®å½¹å‰²ã«å¿œã˜ãŸæ¨©é™

4. **é–‹ç™ºç”¨ã®ç‰¹åˆ¥è¨­å®š**:
   - ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯åˆ¶é™ã‚’ç·©å’Œ
   - æœ¬ç•ªç’°å¢ƒã§ã¯å³æ ¼ã«é‹ç”¨

ã“ã‚Œã§ã€Firebaseç„¡æ–™ãƒ—ãƒ©ãƒ³ã§ã‚‚å®‰å…¨ã«ã‚¢ãƒ—ãƒªãŒå‹•ãï¼
*/