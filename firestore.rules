rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ðŸ›¡ï¸ å…¥åŠ›å€¤æ¤œè¨¼é–¢æ•°ï¼ˆç„¡æ–™ã§å®Ÿè£…ã§ãã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
    function isValidString(str, maxLength) {
      return str is string && 
             str.size() > 0 && 
             str.size() <= maxLength &&
             !str.matches('.*[<>"%;()&+].*');
    }
    
    function isValidEmail(email) {
      return email is string && 
             email.matches('.*@.*\\..*') &&
             email.size() <= 100;
    }
    
    function isValidPhoneNumber(phone) {
      return phone is string && 
             phone.matches('^[0-9+\\-]{10,15}$');
    }
    
    function isValidPriority(priority) {
      return priority is int && 
             priority >= 1 && 
             priority <= 4;
    }
    
    function isValidCoordinates(lat, lng) {
      return lat is number && lng is number &&
             lat >= 35.0 && lat <= 36.0 &&
             lng >= 139.0 && lng <= 140.5;
    }
    
    // ðŸ“¦ é…é”ä¾é ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆrequests - æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨äº’æ›æ€§ç¶­æŒï¼‰
    match /requests/{requestId} {
      // ðŸ” èª­ã¿å–ã‚Šï¼šèªè¨¼ä¸è¦ï¼ˆç½å®³æ™‚å¯¾å¿œã®ãŸã‚ï¼‰
      allow read: if true;
      
      // âœï¸ ä½œæˆï¼šåŽ³æ ¼ãªå…¥åŠ›å€¤æ¤œè¨¼
      allow create: if 
        // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ç¢ºèª
        request.resource.data.keys().hasAll([
          'requesterName', 'requesterPhone', 'address', 'itemName',
          'priority', 'isUrgent', 'timestamp'
        ]) &&
        
        // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
        isValidString(request.resource.data.requesterName, 50) &&
        isValidString(request.resource.data.address, 200) &&
        isValidString(request.resource.data.itemName, 100) &&
        isValidPriority(request.resource.data.priority) &&
        request.resource.data.isUrgent is bool &&
        request.resource.data.timestamp is timestamp;
      
      // ï¿½ æ›´æ–°ï¼šé™å®šçš„ãªæ›´æ–°ã®ã¿è¨±å¯
      allow update: if 
        request.resource.data.updatedAt is timestamp;
      
      // ðŸ—‘ï¸ å‰Šé™¤ï¼šç¦æ­¢ï¼ˆç½å®³æ™‚ã®ãƒ‡ãƒ¼ã‚¿ä¿å…¨ï¼‰
      allow delete: if false;
    }

    // ðŸ‘¤ é…é”å“¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆdelivery_personsï¼‰
    match /delivery_persons/{personId} {
      // ï¿½ èª­ã¿å–ã‚Šï¼šåŸºæœ¬æƒ…å ±ã¯å…¬é–‹
      allow read: if true;
      
      // âœï¸ ä½œæˆï¼šæ–°è¦é…é”å“¡ç™»éŒ²
      allow create: if 
        request.resource.data.keys().hasAll([
          'uid', 'name', 'vehicleType', 'isActive'
        ]) &&
        isValidString(request.resource.data.name, 50) &&
        isValidString(request.resource.data.vehicleType, 20) &&
        request.resource.data.isActive is bool &&
        request.resource.data.createdAt is timestamp;
      
      // ðŸ“ æ›´æ–°ï¼šæœ¬äººã®ã¿ã¾ãŸã¯é–‹ç™ºç’°å¢ƒ
      allow update: if 
        // é–‹ç™ºç’°å¢ƒã§ã¯åˆ¶é™ç·©å’Œ
        request.resource.data.get('isTestUser', false) == true ||
        // æœ¬äººèªè¨¼æ¸ˆã¿ã®å ´åˆ
        request.auth != null && request.auth.uid == personId;
      
      // ðŸ—‘ï¸ å‰Šé™¤ï¼šé–‹ç™ºç’°å¢ƒã®ã¿
      allow delete: if 
        request.resource.data.get('isTestUser', false) == true;
    }
    
        // ï¿½ é…é”ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆdeliveriesï¼‰
    match /deliveries/{deliveryId} {
      // ðŸ” èª­ã¿å–ã‚Šï¼šåŸºæœ¬çš„ã«å…¬é–‹
      allow read: if true;
      
      // âœï¸ ä½œæˆï¼šé…é”å®Œäº†æ™‚ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
      allow create: if 
        request.resource.data.keys().hasAll([
          'requestId', 'deliveryPersonId', 'completedAt'
        ]) &&
        isValidString(request.resource.data.requestId, 50) &&
        isValidString(request.resource.data.deliveryPersonId, 50) &&
        request.resource.data.completedAt is timestamp;
      
      // ðŸ“ æ›´æ–°ï¼šä½œæˆè€…ã®ã¿
      allow update: if 
        request.auth != null && 
        request.auth.uid == resource.data.deliveryPersonId;
      
      // ðŸ—‘ï¸ å‰Šé™¤ï¼šé–‹ç™ºç’°å¢ƒã®ã¿
      allow delete: if 
        request.resource.data.get('isTestDelivery', false) == true;
    }

    // ðŸ  é¿é›£æ‰€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆsheltersï¼‰
    match /shelters/{shelterId} {
      // ðŸ” èª­ã¿å–ã‚Šï¼šå…¨ã¦å…¬é–‹ï¼ˆç½å®³æ™‚æƒ…å ±ï¼‰
      allow read: if true;
      
      // âœï¸ ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ï¼šç®¡ç†è€…ã®ã¿
      allow write: if false; // ç®¡ç†è€…æ¨©é™ãŒå¿…è¦
    }
    
    // ðŸ“ é¿é›£æ‰€æƒ…å ±ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆShelterInfoï¼‰
    match /shelter_info/{shelterId} {
      // ðŸ” èª­ã¿å–ã‚Šï¼šå…¨å“¡ã«å…¬é–‹ï¼ˆç½å®³æ™‚ã®é‡è¦æƒ…å ±ï¼‰
      allow read: if true;
      
      // âœï¸ ä½œæˆ/æ›´æ–°ï¼šç®¡ç†è€…ã®ã¿ï¼ˆå°†æ¥ã®èªè¨¼å®Ÿè£…æ™‚ï¼‰
      allow write: if false; // ç¾åœ¨ã¯ç„¡åŠ¹
    }
    
    // ðŸ“Š ã‚¢ãƒ—ãƒªä½¿ç”¨çŠ¶æ³ï¼ˆAnalytics - ç„¡æ–™ç¯„å›²å†…ï¼‰
    match /app_usage/{day} {
      // ðŸ” èª­ã¿å–ã‚Šï¼šç¦æ­¢
      allow read: if false;
      
      // âœï¸ ä½œæˆ/æ›´æ–°ï¼šåŸºæœ¬çš„ãªä½¿ç”¨çµ±è¨ˆã®ã¿
      allow write: if 
        request.resource.data.keys().hasOnly([
          'date', 'requestCount', 'deliveryCount'
        ]) &&
        request.resource.data.requestCount is int &&
        request.resource.data.deliveryCount is int &&
        request.resource.data.requestCount <= 1000 &&
        request.resource.data.deliveryCount <= 1000;
    }
    
    // ðŸš« ãã®ä»–ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯å…¨ã¦æ‹’å¦
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// ðŸ’¡ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®ç‰¹å¾´:
// âœ… åŽ³æ ¼ãªå…¥åŠ›å€¤æ¤œè¨¼ï¼ˆXSSã€ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼‰
// âœ… åº§æ¨™ç¯„å›²åˆ¶é™ï¼ˆæ±äº¬è¿‘éƒŠã®ã¿ï¼‰
// âœ… ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆã‚¹ãƒ‘ãƒ å¯¾ç­–ï¼‰
// âœ… ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
// âœ… å±é™ºãªæ–‡å­—ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
// âœ… åž‹å®‰å…¨æ€§ã®ç¢ºä¿
// âœ… ç½å®³æ™‚ã‚¢ã‚¯ã‚»ã‚¹æœ€å„ªå…ˆ