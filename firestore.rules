rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ›¡ï¸ å…¥åŠ›å€¤æ¤œè¨¼é–¢æ•°ï¼ˆç„¡æ–™ã§å®Ÿè£…ã§ãã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
    function isValidString(str, maxLength) {
      return str is string && 
             str.size() > 0 && 
             str.size() <= maxLength &&
             !str.matches('.*[<>"%;()&+].*');
    }
    
    function isValidEmail(email) {
      return email is string && 
             email.matches('.*@.*\\..*') &&
             email.size() <= 100;
    }
    
    function isValidPhoneNumber(phone) {
      return phone is string && 
             phone.matches('^[0-9+\\-]{10,15}$');
    }
    
    function isValidPriority(priority) {
      return priority is int && 
             priority >= 1 && 
             priority <= 4;
    }

    // è¿½åŠ : æ–‡å­—åˆ— priority ã‚’ä¸€æ™‚çš„ã«è¨±å¯ (high / medium / low)
    function isValidPriorityString(p) {
      return p is string && ['high','medium','low'].hasAny([p]);
    }
    
    function isValidCoordinates(lat, lng) {
      return lat is number && lng is number &&
             lat >= 35.0 && lat <= 36.0 &&
             lng >= 139.0 && lng <= 140.5;
    }
    
    // ğŸ“¦ é…é”ä¾é ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆrequests - æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨äº’æ›æ€§ç¶­æŒï¼‰
    match /requests/{requestId} {
      // ğŸ” èª­ã¿å–ã‚Šï¼šèª°ã§ã‚‚èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if true;
      
      // âœï¸ ä½œæˆï¼šèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã§ãã€ä½œæˆè€…ã®UIDãŒcreatorUidã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ¤œè¨¼
  // ãƒ‡ãƒ¢ / é€£æºãƒ†ã‚¹ãƒˆç”¨ã«å¿…é ˆé …ç›®ã‚’ä¸€æ™‚ç·©å’Œ:
  // address, requesterPhone, isUrgent ã‚’ä»»æ„åŒ– (æœ¬ç•ªå¾©å¸°æ™‚ã¯å†åº¦ hasAll ã«æˆ»ã™)
      allow create: if 
        request.auth != null &&
        request.auth.uid == request.resource.data.creatorUid &&
        // æœ€å°é™å¿…é ˆ (requesterName, itemName, priority, timestamp, creatorUid)
        request.resource.data.keys().hasAll([
          'requesterName', 'itemName', 'priority', 'timestamp', 'creatorUid'
        ]) &&
        isValidString(request.resource.data.requesterName, 50) &&
        isValidString(request.resource.data.itemName, 100) &&
        (
          isValidPriority(request.resource.data.priority) ||
          isValidPriorityString(request.resource.data.priority)
        ) &&
        request.resource.data.timestamp is timestamp;
      
      // ğŸ“ æ›´æ–°ï¼šå‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸé…é”å“¡ã¾ãŸã¯ä½œæˆè€…ã®ã¿æ›´æ–°å¯èƒ½
      // update ãƒ«ãƒ¼ãƒ«æ‹¡å¼µ: åˆå›å¼•ãå—ã‘(claim)ã‚’è¨±å¯
      // æ¡ä»¶ A: ä½œæˆè€…æœ¬äºº
      // æ¡ä»¶ B: æ—¢ã«æ‹…å½“ã¨ã—ã¦è¨­å®šæ¸ˆã¿ã®é…é”å“¡ (deliveryPersonId == è‡ªåˆ†)
      // æ¡ä»¶ C: ã¾ã èª°ã‚‚æ‹…å½“ã—ã¦ãŠã‚‰ãš(status==waiting ã‹ã¤ deliveryPersonId æœªè¨­å®š/ null) ã®çŠ¶æ…‹ã§
      //          è‡ªåˆ†ã®UIDã‚’ deliveryPersonId ã«è¨­å®šã— status ã‚’ assigned/delivering ã«å¤‰æ›´ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹åˆå›claim
      allow update: if 
        request.auth != null &&
        (
          // A
          resource.data.creatorUid == request.auth.uid ||
          // B
          resource.data.deliveryPersonId == request.auth.uid ||
          // C (åˆå›claim)
          (
            // ã¾ã æ‹…å½“è€…ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ (deliveryPersonId ç„¡ã— or null)
            (!('deliveryPersonId' in resource.data) || resource.data.deliveryPersonId == null) &&
            resource.data.status == 'waiting' &&
            // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§ã¯è‡ªåˆ†ã‚’è¨­å®šã— waiting -> assigned ã¸å¤‰æ›´ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹
            request.resource.data.deliveryPersonId == request.auth.uid &&
            request.resource.data.status in ['assigned','delivering']
          )
        ) &&
        request.resource.data.updatedAt is timestamp; // æ›´æ–°æ™‚ã« updatedAt ãŒå¿…é ˆ
      
      // ğŸ—‘ï¸ å‰Šé™¤ï¼šç¦æ­¢ï¼ˆç½å®³æ™‚ã®ãƒ‡ãƒ¼ã‚¿ä¿å…¨ï¼‰
      allow delete: if false;
    }

    // ğŸ‘¤ é…é”å“¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆdelivery_personsï¼‰
    match /delivery_persons/{personId} {
      // ğŸ” èª­ã¿å–ã‚Šï¼šèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†è‡ªèº«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if request.auth != null && request.auth.uid == personId;
      
      // âœï¸ ä½œæˆï¼šèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªèº«ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä½œæˆã§ãã‚‹ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã¨uidãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®UIDã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚
      allow create: if 
        request.auth != null && // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚‹ã“ã¨
        personId == request.auth.uid && // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®UIDã¨ä¸€è‡´ã™ã‚‹ã“ã¨
        request.resource.data.uid == request.auth.uid && // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ã®uidãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®UIDã¨ä¸€è‡´ã™ã‚‹ã“ã¨
        request.resource.data.keys().hasAll([
          'uid', 'name', 'vehicleType', 'isActive', 'createdAt'
        ]) &&
        isValidString(request.resource.data.name, 50) &&
        isValidString(request.resource.data.vehicleType, 20) &&
        request.resource.data.isActive is bool &&
        request.resource.data.createdAt is timestamp;
      
      // ğŸ“ æ›´æ–°ï¼šèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†è‡ªèº«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿æ›´æ–°å¯èƒ½
      allow update: if 
        request.auth != null && // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚‹ã“ã¨
        request.auth.uid == personId; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†è‡ªèº«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¦ã„ã‚‹ã“ã¨
      
      // ğŸ—‘ï¸ å‰Šé™¤ï¼šç¦æ­¢ï¼ˆãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¾‹å¤–ã¯å‰Šé™¤ã—ã€ã‚ˆã‚Šã‚»ã‚­ãƒ¥ã‚¢ã«ï¼‰
      allow delete: if false;
    }
    
    // ğŸšš é…é”ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆdeliveriesï¼‰ - å¤‰æ›´ãªã—
    match /deliveries/{deliveryId} {
      // ğŸ” èª­ã¿å–ã‚Šï¼šåŸºæœ¬çš„ã«å…¬é–‹
      allow read: if true;
      
      // âœï¸ ä½œæˆï¼šé…é”å®Œäº†æ™‚ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
      allow create: if 
        request.resource.data.keys().hasAll([
          'requestId', 'deliveryPersonId', 'completedAt'
        ]) &&
        isValidString(request.resource.data.requestId, 50) &&
        isValidString(request.resource.data.deliveryPersonId, 50) &&
        request.resource.data.completedAt is timestamp;
      
      // ğŸ“ æ›´æ–°ï¼šä½œæˆè€…ã®ã¿
      allow update: if 
        request.auth != null && 
        request.auth.uid == resource.data.deliveryPersonId;
      
      // ğŸ—‘ï¸ å‰Šé™¤ï¼šé–‹ç™ºç’°å¢ƒã®ã¿
      allow delete: if 
        request.resource.data.get('isTestDelivery', false) == true;
    }

    // ğŸ  é¿é›£æ‰€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆsheltersï¼‰
    match /shelters/{shelterId} {
      // ğŸ” èª­ã¿å–ã‚Šï¼šèª°ã§ã‚‚èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if true;

      // âœï¸ ä¸€æ™‚çš„ã‚·ãƒ¼ãƒ‰ç”¨: æŒ‡å®šUIDã®ã¿ create ã‚’è¨±å¯ï¼ˆãƒãƒƒã‚«ã‚½ãƒ³å¾Œå‰Šé™¤äºˆå®šï¼‰
      allow create: if request.auth != null &&
        request.auth.uid == 'PiOkqKfGXDPfqzLnm7WTI8Abvcl2' &&
        request.resource.data.keys().hasAll(['name','location','status']) &&
        request.resource.data.status in ['open','full','closed'];
      // æ›´æ–°ã¯ç¦æ­¢ã€‚å‰Šé™¤ã¯ç©º address ã‹ã¤ facilities ç©ºé…åˆ—ãªã©ã‚·ãƒ¼ãƒ‰åˆ¤å®šã«ä¸€è‡´ã—ã€ã‹ã¤åŒä¸€UIDã®ã¿è¨±å¯
      allow update: if false;
      allow delete: if request.auth != null &&
        request.auth.uid == 'PiOkqKfGXDPfqzLnm7WTI8Abvcl2' &&
        resource.data.address == '' &&
        resource.data.currentOccupancy == 0 &&
        resource.data.capacity == 300 &&
        resource.data.facilities.size() == 0;
    }
    
    // ğŸ“ é¿é›£æ‰€æƒ…å ±ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆShelterInfoï¼‰ - å¤‰æ›´ãªã—
    match /shelter_info/{shelterId} {
      // ğŸ” èª­ã¿å–ã‚Šï¼šå…¨å“¡ã«å…¬é–‹ï¼ˆç½å®³æ™‚ã®é‡è¦æƒ…å ±ï¼‰
      allow read: if true;
      
      // âœï¸ ä½œæˆ/æ›´æ–°ï¼šç®¡ç†è€…ã®ã¿ï¼ˆå°†æ¥ã®èªè¨¼å®Ÿè£…æ™‚ï¼‰
      allow write: if false; // ç¾åœ¨ã¯ç„¡åŠ¹
    }
    
    // ğŸ“Š ã‚¢ãƒ—ãƒªä½¿ç”¨çŠ¶æ³ï¼ˆAnalytics - ç„¡æ–™ç¯„å›²å†…ï¼‰ - å¤‰æ›´ãªã—
    match /app_usage/{day} {
      // ğŸ” èª­ã¿å–ã‚Šï¼šç¦æ­¢
      allow read: if false;
      
      // âœï¸ ä½œæˆ/æ›´æ–°ï¼šåŸºæœ¬çš„ãªä½¿ç”¨çµ±è¨ˆã®ã¿
      allow write: if 
        request.resource.data.keys().hasOnly([
          'date', 'requestCount', 'deliveryCount'
        ]) &&
        request.resource.data.requestCount is int &&
        request.resource.data.deliveryCount is int &&
        request.resource.data.requestCount <= 1000 &&
        request.resource.data.deliveryCount <= 1000;
    }
    
    // ğŸš« ãã®ä»–ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯å…¨ã¦æ‹’å¦
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
