// 🔒 Firestore セキュリティルール（本番用）
// Firebase Console の Rules タブにコピー&ペーストしてください

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 📋 requests コレクション（配達要請）
    match /requests/{requestId} {
      // 誰でも読み取り可能（被災者・配達員が要請を確認するため）
      allow read: if true;
      
      // 新規作成は誰でも可能（被災者が緊急要請を送るため）
      allow create: if true;
      
      // 更新は制限付きで許可（配達員が状況更新するため）
      allow update: if 
        // 既存のデータの重要フィールドは変更不可
        !('requesterName' in resource.data) ||
        !('item' in resource.data) ||
        !('phone' in resource.data) ||
        !('latitude' in resource.data) ||
        !('longitude' in resource.data) ||
        !('timestamp' in resource.data) ||
        // 重要フィールドが変更されていない場合のみ許可
        (resource.data.requesterName == request.data.requesterName &&
         resource.data.item == request.data.item &&
         resource.data.phone == request.data.phone &&
         resource.data.latitude == request.data.latitude &&
         resource.data.longitude == request.data.longitude &&
         resource.data.timestamp == request.data.timestamp);
      
      // 削除は完全に禁止（データ保持のため）
      allow delete: if false;
    }
    
    // 📊 deliveries コレクション（配達履歴）
    match /deliveries/{deliveryId} {
      // 読み取りは誰でも可能（統計情報のため）
      allow read: if true;
      
      // 作成のみ許可（履歴は追加のみ）
      allow create: if true;
      
      // 更新・削除は禁止（履歴改ざん防止）
      allow update, delete: if false;
    }
    
    // 🔒 その他のコレクション（将来追加用）
    match /{document=**} {
      // デフォルトは読み取りのみ
      allow read: if true;
      allow write: if false;
    }
  }
}

/*
🛡️ 本番用セキュリティ解説：
✅ 許可されること：
- 誰でも要請の読み取り（緊急時の透明性）
- 誰でも新規要請の作成（被災者の緊急アクセス）
- 配達員による配達状況の更新（statusやdeliveryPersonIdのみ）
- 配達履歴の作成・読み取り

❌ 禁止されること：
- 要請の重要情報の変更（requesterName, item, phone, 位置情報等）
- 要請・履歴の削除
- 配達履歴の変更

🚨 災害時の特別考慮：
- 緊急性を優先して認証なしでもアクセス可能
- ただし重要データの改ざんは防止
- 将来的に認証機能追加時は認証必須に変更可能
*/