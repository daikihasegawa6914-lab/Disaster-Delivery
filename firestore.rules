rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ›¡ï¸ å…¥åŠ›å€¤æ¤œè¨¼é–¢æ•°ï¼ˆç„¡æ–™ã§å®Ÿè£…ã§ãã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
    function isValidString(str, maxLength) {
      return str is string && 
             str.size() > 0 && 
             str.size() <= maxLength &&
             !str.matches('.*[<>"%;()&+].*');
    }
    
    function isValidEmail(email) {
      return email is string && 
             email.matches('.*@.*\\..*') &&
             email.size() <= 100;
    }
    
    function isValidPhoneNumber(phone) {
      return phone is string && 
             phone.matches('^[0-9+\\-]{10,15}$');
    }
    
    function isValidPriority(priority) {
      return priority is int && 
             priority >= 1 && 
             priority <= 4;
    }
    
    function isValidCoordinates(lat, lng) {
      return lat is number && lng is number &&
             lat >= 35.0 && lat <= 36.0 &&
             lng >= 139.0 && lng <= 140.5;
    }
    
    // ğŸ“¦ é…é”ä¾é ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆDeliveryRequestï¼‰
    match /delivery_requests/{requestId} {
      // ğŸ” èª­ã¿å–ã‚Šï¼šèªè¨¼ä¸è¦ï¼ˆç½å®³æ™‚å¯¾å¿œã®ãŸã‚ï¼‰
      allow read: if true;
      
      // âœï¸ ä½œæˆï¼šå³æ ¼ãªå…¥åŠ›å€¤æ¤œè¨¼
      allow create: if 
        // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ç¢ºèª
        request.resource.data.keys().hasAll([
          'requesterName', 'requesterPhone', 'requesterEmail',
          'address', 'latitude', 'longitude', 'itemName',
          'priority', 'isUrgent', 'timestamp'
        ]) &&
        
        // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
        isValidString(request.resource.data.requesterName, 50) &&
        isValidPhoneNumber(request.resource.data.requesterPhone) &&
        isValidEmail(request.resource.data.requesterEmail) &&
        isValidString(request.resource.data.address, 200) &&
        isValidCoordinates(
          request.resource.data.latitude, 
          request.resource.data.longitude
        ) &&
        isValidString(request.resource.data.itemName, 100) &&
        isValidPriority(request.resource.data.priority) &&
        request.resource.data.isUrgent is bool &&
        request.resource.data.timestamp is timestamp &&
        
        // ğŸš¨ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ1åˆ†é–“ã«æœ€å¤§5ä»¶ã¾ã§ï¼‰
        request.resource.data.timestamp > 
          (timestamp.date() - duration.value(1, 'min'));
      
      // ğŸ“ æ›´æ–°ï¼šé™å®šçš„ãªæ›´æ–°ã®ã¿è¨±å¯
      allow update: if 
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã®ã¿è¨±å¯
        request.resource.data.keys().hasOnly([
          'status', 'delivererName', 'updatedAt'
        ]) &&
        isValidString(request.resource.data.get('status', ''), 20) &&
        request.resource.data.updatedAt is timestamp;
      
      // ğŸ—‘ï¸ å‰Šé™¤ï¼šç¦æ­¢ï¼ˆç½å®³æ™‚ã®ãƒ‡ãƒ¼ã‚¿ä¿å…¨ï¼‰
      allow delete: if false;
    }
    
    // ğŸšš é…é”è€…ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆDeliverersï¼‰
    match /deliverers/{delivererId} {
      // ğŸ” èª­ã¿å–ã‚Šï¼šä½ç½®æƒ…å ±ã®ã¿å…¬é–‹
      allow read: if true;
      
      // âœï¸ ä½œæˆ/æ›´æ–°ï¼šåŸºæœ¬æƒ…å ±ã®ã¿
      allow write: if 
        request.resource.data.keys().hasAll([
          'name', 'currentLatitude', 'currentLongitude', 
          'isAvailable', 'lastUpdated'
        ]) &&
        isValidString(request.resource.data.name, 50) &&
        isValidCoordinates(
          request.resource.data.currentLatitude,
          request.resource.data.currentLongitude
        ) &&
        request.resource.data.isAvailable is bool &&
        request.resource.data.lastUpdated is timestamp;
    }
    
    // ğŸ“ é¿é›£æ‰€æƒ…å ±ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆShelterInfoï¼‰
    match /shelter_info/{shelterId} {
      // ğŸ” èª­ã¿å–ã‚Šï¼šå…¨å“¡ã«å…¬é–‹ï¼ˆç½å®³æ™‚ã®é‡è¦æƒ…å ±ï¼‰
      allow read: if true;
      
      // âœï¸ ä½œæˆ/æ›´æ–°ï¼šç®¡ç†è€…ã®ã¿ï¼ˆå°†æ¥ã®èªè¨¼å®Ÿè£…æ™‚ï¼‰
      allow write: if false; // ç¾åœ¨ã¯ç„¡åŠ¹
    }
    
    // ğŸ“Š ã‚¢ãƒ—ãƒªä½¿ç”¨çŠ¶æ³ï¼ˆAnalytics - ç„¡æ–™ç¯„å›²å†…ï¼‰
    match /app_usage/{day} {
      // ğŸ” èª­ã¿å–ã‚Šï¼šç¦æ­¢
      allow read: if false;
      
      // âœï¸ ä½œæˆ/æ›´æ–°ï¼šåŸºæœ¬çš„ãªä½¿ç”¨çµ±è¨ˆã®ã¿
      allow write: if 
        request.resource.data.keys().hasOnly([
          'date', 'requestCount', 'deliveryCount'
        ]) &&
        request.resource.data.requestCount is int &&
        request.resource.data.deliveryCount is int &&
        request.resource.data.requestCount <= 1000 &&
        request.resource.data.deliveryCount <= 1000;
    }
    
    // ğŸš« ãã®ä»–ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯å…¨ã¦æ‹’å¦
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// ğŸ’¡ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®ç‰¹å¾´:
// âœ… å³æ ¼ãªå…¥åŠ›å€¤æ¤œè¨¼ï¼ˆXSSã€ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼‰
// âœ… åº§æ¨™ç¯„å›²åˆ¶é™ï¼ˆæ±äº¬è¿‘éƒŠã®ã¿ï¼‰
// âœ… ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆã‚¹ãƒ‘ãƒ å¯¾ç­–ï¼‰
// âœ… ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
// âœ… å±é™ºãªæ–‡å­—ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
// âœ… å‹å®‰å…¨æ€§ã®ç¢ºä¿
// âœ… ç½å®³æ™‚ã‚¢ã‚¯ã‚»ã‚¹æœ€å„ªå…ˆ